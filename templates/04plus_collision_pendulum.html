{%  extends 'base.html' %}
{% block content %}
  <script>
    document.getElementById("prev-link").href="/04_collision_pendulum";
    document.getElementById("next-link").href="/05_parabolic_motion";
    document.getElementById("desc-span").innerHTML="4/8";
  </script>

  <header id='overview'>
    <h1>시뮬레이션 4+. 다중 진자 충돌</h1>
    <p class="headerDescription">
      여러 개의 진자 충돌을 기술한다.
    </p>
  </header>
  <hr>
  <div id="engine-container">
    <div id="gui-container"></div>
    <canvas id="canvas" width="800px" height="600px"></canvas>
  </div>

  <script type="text/javascript" src="../static/js/npengine.dev.js"></script>
  <script type="text/javascript" src="../static/js/dat.gui.min.js"></script>
  <script type="text/javascript">
    var engine = new NPEngine(document.getElementById("canvas"));
    var pendulumCollision = new NPEngine.PendulumCollision3;
    engine.addDisplayObject(pendulumCollision);
    engine.ready();

    // default value
    var DefaultValue = function () {
      this.beforeNumber = 4;
      this.number = 4;
      this.gravity = 9.8;
      this.k = 10000000;
      this.angle1 = 0;
      this.angle2 = 0;
      this.angle3 = 0;
      this.angle4 = 45;
    };

    window.onload = function () {
      var defaultValue = new DefaultValue();
      var gui = new dat.GUI();
      document.getElementById("gui-container").appendChild(gui.domElement);

      var numFolder = gui.addFolder('진자 수');
      numFolder.open();
      var num = numFolder.add(defaultValue, 'number', 1, 10).step(1);
      num.onFinishChange(function (value) {
        setAngleGUI();
        engine.stop();
        pendulumCollision.setNumOfPendulum(value);
        engine.ready();
      });

      var gravityFolder = gui.addFolder('중력 (m/s^2)');
      gravityFolder.open();
      var gravity = gravityFolder.add(defaultValue, 'gravity');
      gravity.onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setGravity(value);
        engine.ready();
      });

      var kFolder = gui.addFolder('k (N/m)');
      kFolder.open();
      var k = kFolder.add(defaultValue, 'k');
      k.onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setK(Math.round(value));
        engine.ready();
      });

      var angles = [];
      var angleFolder = gui.addFolder('초기 각도 (degree)');
      angleFolder.open();
      defaultValue.reset = function() {
        engine.stop();
        for (var i=0; i<defaultValue.number; i++) {
          defaultValue['angle' + (i + 1)] = 0;
          angles[i].updateDisplay();
          pendulumCollision.setAngleByIndex(0, i+1);
        }
        engine.ready();
      };
      angleFolder.add(defaultValue, 'reset');
      angles[0] = angleFolder.add(defaultValue, 'angle1');
      angles[0].onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setAngleByIndex(value, 0);
        engine.ready();
      });
      angles[1] = angleFolder.add(defaultValue, 'angle2');
      angles[1].onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setAngleByIndex(value, 1);
        engine.ready();
      });
      angles[2] = angleFolder.add(defaultValue, 'angle3');
      angles[2].onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setAngleByIndex(value, 2);
        engine.ready();
      });
      angles[3] = angleFolder.add(defaultValue, 'angle4');
      angles[3].onFinishChange(function (value) {
        engine.stop();
        pendulumCollision.setAngleByIndex(value, 3);
        engine.ready();
      });

      function setAngleGUI() {
        // add new value
        for (var i=0; i<defaultValue.number; i++) {
          if (!defaultValue.hasOwnProperty('angle' + (i + 1))) {
            defaultValue['angle' + (i + 1)] = 0;
            angles[i] = angleFolder.add(defaultValue, 'angle' + (i + 1));
            angles[i].onFinishChange(getHandler(i));
            function getHandler(index) {
              return function(value) {
                engine.stop();
                pendulumCollision.setAngleByIndex(value, index);
                engine.ready();
              }
            }
          }
          else {
            angles[i].updateDisplay();
          }
        }

        // delete unresolve value
        for (var i = defaultValue.number; i < defaultValue.beforeNumber; i++) {
          delete defaultValue['angle' + (i + 1)];
          angleFolder.remove(angles[i]);
        }

        defaultValue.beforeNumber = defaultValue.number;
      };
    }
  </script>
{% endblock %}
